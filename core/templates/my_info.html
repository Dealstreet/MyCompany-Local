{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<div class="container-fluid" style="max-width: 1000px;">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold m-0" style="color: #1e293b;">λ‚΄ μ •λ³΄ κ΄€λ¦¬</h3>

        <!-- Social Stats -->
        <div class="d-flex gap-3">
            <div class="text-center px-3 py-2 bg-white rounded-pill shadow-sm border">
                <small class="text-muted d-block" style="font-size: 0.75rem;">ν”λ΅μ›</small>
                <span class="fw-bold text-dark">{{ followers_count }}</span>
            </div>
            <div class="text-center px-3 py-2 bg-white rounded-pill shadow-sm border" style="cursor: pointer;"
                data-bs-toggle="modal" data-bs-target="#followingModal">
                <small class="text-muted d-block" style="font-size: 0.75rem;">ν”λ΅μ‰</small>
                <span class="fw-bold text-dark">{{ following_count }}</span>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Left: User & Company Info -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm mb-4" style="border-radius: 20px;">
                <div class="card-header bg-white border-0 pt-4 px-4 pb-0">
                    <h5 class="fw-bold mb-0">π‘¤ κΈ°λ³Έ μ •λ³΄ μμ •</h5>
                </div>
                <div class="card-body p-4">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" name="update_info" value="1">

                        <div class="mb-3">
                            <label class="form-label fw-bold text-muted small">μ•„μ΄λ”” (λ³€κ²½λ¶κ°€)</label>
                            <input type="text" class="form-control" value="{{ user.username }}" disabled>
                        </div>

                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label fw-bold text-muted small">μ„±</label>
                                {{ user_form.last_name }}
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label fw-bold text-muted small">μ΄λ¦„</label>
                                {{ user_form.first_name }}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold text-muted small">μƒλ…„μ›”μΌ</label>
                            {{ user_form.birth_date }}
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold text-muted small">μ΄λ©”μΌ</label>
                            {{ user_form.email }}
                        </div>

                        <hr class="my-4">

                        <h5 class="fw-bold mb-3">πΆ νμ‚¬ μ •λ³΄</h5>
                        <div class="mb-3">
                            <label class="form-label fw-bold text-muted small">νμ‚¬λ…</label>
                            {{ org_form.name }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold text-muted small">νμ‚¬ μ„¤λ…</label>
                            {{ org_form.description }}
                        </div>

                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-primary rounded-pill fw-bold py-2">
                                μ •λ³΄ μ €μ¥
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Password Change Link -->
            <div class="text-center">
                <form method="post" style="display:inline;">
                    {% csrf_token %}
                    <input type="hidden" name="update_password" value="1">
                    <button type="submit" class="btn btn-link text-muted text-decoration-none small">
                        λΉ„λ°€λ²νΈ λ³€κ²½ν•κΈ° &gt;
                    </button>
                </form>
            </div>
        </div>

        <!-- Right: Portfolio Disclosure Settings -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm" style="border-radius: 20px; height: 100%;">
                <div
                    class="card-header bg-white border-0 pt-4 px-4 pb-0 d-flex justify-content-between align-items-center">
                    <h5 class="fw-bold mb-0">π”’ ν¬νΈν΄λ¦¬μ¤ κ³µκ° μ„¤μ •</h5>
                    <span class="badge bg-light text-dark border">
                        CEO λ­ν‚Ή μ°Έμ—¬μ©
                    </span>
                </div>
                <div class="card-body p-4">
                    <p class="text-muted small mb-4">
                        μ²΄ν¬λ μΆ…λ©μ€ <strong>ν¬νΈν΄λ¦¬μ¤ λ­ν‚Ή</strong> νμ΄μ§€μ—μ„ λ‹¤λ¥Έ CEOλ“¤μ—κ² μμµλ¥ μ΄ κ³µκ°λ©λ‹λ‹¤.<br>
                        (λ³΄μ  μλ‰κ³Ό κΈμ•΅μ€ κ³µκ°λμ§€ μ•μΌλ©°, <strong>μμµλ¥ (%)</strong>λ§ κ³µκ°λ©λ‹λ‹¤.)
                    </p>

                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="update_disclosure" value="1">

                        <div class="list-group list-group-flush mb-4 border rounded"
                            style="max-height: 400px; overflow-y: auto;">
                            {% for item in stock_disclosures %}
                            <label class="list-group-item d-flex justify-content-between align-items-center py-3"
                                style="cursor: pointer;">
                                <div class="d-flex align-items-center gap-3">
                                    <input class="form-check-input flex-shrink-0 m-0" type="checkbox"
                                        name="public_stocks" value="{{ item.stock.id }}"
                                        style="width: 20px; height: 20px;" {% if item.is_public %}checked{% endif %}>
                                    <div>
                                        <div class="fw-bold">{{ item.stock.name }}</div>
                                        <div class="text-muted small track-code">{{ item.stock.code }}</div>
                                    </div>
                                </div>
                                <span
                                    class="badge {% if item.is_public %}bg-success-subtle text-success{% else %}bg-secondary-subtle text-secondary{% endif %} rounded-pill">
                                    {% if item.is_public %}κ³µκ°{% else %}λΉ„κ³µκ°{% endif %}
                                </span>
                            </label>
                            {% empty %}
                            <div class="text-center py-5 text-muted">
                                λ³΄μ  μ¤‘μΈ κ΄€μ‹¬ μΆ…λ©μ΄ μ—†μµλ‹λ‹¤.
                            </div>
                            {% endfor %}
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-dark rounded-pill fw-bold py-2">
                                κ³µκ° μ„¤μ • μ €μ¥
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Following Management Modal -->
<div class="modal fade" id="followingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow" style="border-radius: 20px;">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">ν”λ΅μ‰ λ©λ΅</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="list-group list-group-flush">
                    {% for follow in following_list %}
                    <div
                        class="list-group-item px-0 py-3 border-bottom d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-3">
                            <div class="rounded-circle bg-light d-flex align-items-center justify-content-center text-muted fw-bold border"
                                style="width: 40px; height: 40px;">
                                {{ follow.following.last_name|slice:":1" }}
                            </div>
                            <div>
                                <div class="fw-bold text-dark">{{ follow.following.last_name }}{{
                                    follow.following.first_name }}</div>
                                <div class="text-muted small">{{ follow.following.organization.name }}</div>
                            </div>
                        </div>
                        <form action="{% url 'follow_toggle' follow.following.id %}" method="post">
                            {% csrf_token %}
                            <button type="submit"
                                class="btn btn-outline-secondary btn-sm rounded-pill px-3">μ–Έν”λ΅μ°</button>
                        </form>
                    </div>
                    {% empty %}
                    <div class="text-center py-5 text-muted">
                        μ•„μ§ ν”λ΅μ°ν• μ‚¬λμ΄ μ—†μµλ‹λ‹¤. <br>
                        μ»¤λ®¤λ‹ν‹°μ—μ„ ν™λ™ν•λ” λ‹¤λ¥Έ CEOλ“¤μ„ μ°Ύμ•„λ³΄μ„Έμ”!
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}