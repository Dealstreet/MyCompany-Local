{% extends "base.html" %}
{% load static %}

{% block title %}ğŸ“ˆ ì „ëµ ë°±í…ŒìŠ¤íŒ…{% endblock %}

{% block content %}
<div class="row g-3">
    <!-- Left: My Strategies -->
    <div class="col-lg-3">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0">ğŸ’¾ ë‚´ ì „ëµ ëª©ë¡</h6>
                <button class="btn btn-sm btn-light py-0" onclick="showSaveModal()">+ ì €ì¥</button>
            </div>
            <div class="card-body p-0" style="overflow-y: auto; max-height: 800px;">
                <div class="list-group list-group-flush" id="strategyList">
                    {% for strategy in my_strategies %}
                    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                        id="strategy-row-{{ strategy.id }}">
                        <div style="cursor: pointer;" onclick="loadStrategy({{ strategy.id }})"
                            class="d-flex flex-column text-truncate">
                            <span class="fw-bold">{{ strategy.name }}</span>
                            <small class="text-muted" style="font-size: 0.8rem;">
                                {{ strategy.ticker|default:"-" }} | {{ strategy.updated_at|date:"m/d H:i" }}
                            </small>
                        </div>
                        <button class="btn btn-sm btn-outline-danger border-0"
                            onclick="deleteStrategy({{ strategy.id }}, event)">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                    {% empty %}
                    <div class="text-center p-4 text-muted small">
                        ì €ì¥ëœ ì „ëµì´ ì—†ìŠµë‹ˆë‹¤.<br>
                        ë‚˜ë§Œì˜ ì „ëµì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Center: Strategy Builder -->
    <div class="col-lg-5">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">ğŸ› ï¸ ì „ëµ ë¹Œë”</h5>
                <div>
                    <button class="btn btn-sm btn-outline-light me-1" onclick="resetStrategy()">ì´ˆê¸°í™”</button>
                    <!-- Current Strategy Info -->
                    <span id="currentStrategyLabel" class="badge bg-secondary ms-2" style="display:none;"></span>
                    <input type="hidden" id="currentStrategyId">
                </div>
            </div>
            <div class="card-body" style="overflow-y: auto; max-height: 800px;">
                <form id="strategyForm">
                    <!-- Target Stock & Name (Hidden/Auto) -->
                    <!-- Stock selection is moved to Right panel for simulation context, but Ticker is saved with strategy -->

                    <div class="mb-3">
                        <label class="form-label text-muted small">í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ì „ëµ ì„¤ì •</label>
                        <div class="d-flex gap-2">
                            <input type="text" class="form-control" id="strategyNameInput" placeholder="ì „ëµ ì´ë¦„ (ì €ì¥ ì‹œ ì‚¬ìš©)"
                                readonly style="background-color: #f8f9fa;">
                        </div>
                    </div>

                    <!-- Buy Conditions -->
                    <div class="card mb-3 border-danger">
                        <div class="card-header bg-danger text-white py-2">ë§¤ìˆ˜ ì¡°ê±´ (Logic)</div>
                        <div class="card-body p-2" id="buyLogicContainer">
                            <!-- Helper Text -->
                            <p class="text-muted small mb-2">ì¡°ê±´ ê·¸ë£¹ì„ ì¶”ê°€í•˜ì—¬ ë§¤ìˆ˜ íƒ€ì´ë°ì„ ì •ì˜í•˜ì„¸ìš”.</p>
                            <!-- Root Node -->
                        </div>
                    </div>

                    <!-- Sell Conditions -->
                    <div class="card mb-3 border-primary">
                        <div class="card-header bg-primary text-white py-2">ë§¤ë„ ì¡°ê±´ (Logic)</div>
                        <div class="card-body p-2" id="sellLogicContainer">
                            <p class="text-muted small mb-0">ë§¤ë„ ì¡°ê±´ì´ ì—†ìœ¼ë©´ ë§¤ìˆ˜ í›„ ë³´ìœ í•©ë‹ˆë‹¤.</p>
                        </div>
                    </div>

                    <!-- DCA Config -->
                    <div class="card mb-3 border-secondary">
                        <div class="card-header py-2">
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input" type="checkbox" id="dcaEnabled" onchange="toggleDCA()">
                                <label class="form-check-label" for="dcaEnabled">ğŸ’° ì ë¦½ì‹ íˆ¬ì(DCA) ì„¤ì •</label>
                            </div>
                        </div>
                        <div class="card-body p-2" id="dcaConfigPanel" style="display:none;">
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <label class="form-label small">ë°©ì‹</label>
                                    <select class="form-select form-select-sm" id="dcaType">
                                        <option value="fixed_amount">ë§¤íšŒ ê³ ì • ê¸ˆì•¡ (ì›)</option>
                                        <option value="fixed_quantity">ë§¤íšŒ ê³ ì • ìˆ˜ëŸ‰ (ì£¼)</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">ê°’</label>
                                    <input type="number" class="form-control form-control-sm" id="dcaAmount"
                                        value="100000">
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label small">ì£¼ê¸°</label>
                                    <select class="form-select form-select-sm" id="dcaInterval">
                                        <option value="monthly">ë§¤ì›” 1ì¼</option>
                                        <option value="weekly">ë§¤ì£¼</option>
                                        <option value="daily">ë§¤ì¼</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Right: Backtest Control & Results -->
    <div class="col-lg-4">
        <div class="card shadow-sm mb-3">
            <div class="card-header bg-success text-white">
                <span class="fw-bold">âš™ï¸ ì‹œë®¬ë ˆì´ì…˜ ì„¤ì •</span>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-12">
                        <label class="form-label small">ëŒ€ìƒ ì¢…ëª©</label>
                        <select class="form-select" id="stockSelect">
                            {% for stock in stocks %}
                            <option value="{{ stock.code }}">{{ stock.name }} ({{ stock.code }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label small">ì´ˆê¸° ìë³¸ê¸ˆ</label>
                        <input type="number" class="form-control" id="initialCapital" value="10000000">
                    </div>
                </div>
                <div class="d-grid mt-3">
                    <button class="btn btn-success fw-bold" onclick="runBacktest()">ğŸš€ ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
                </div>
            </div>
        </div>

        <!-- Result Stats -->
        <div id="resultStats" class="row g-2 mb-3" style="display:none;">
            <div class="col-6">
                <div class="card text-center text-white bg-primary h-100">
                    <div class="card-body p-2 d-flex flex-column justify-content-center">
                        <h6 class="card-title my-0" style="font-size:0.75rem;">ìµœì¢… ìì‚°</h6>
                        <span class="fw-bold" id="resFinalCapital" style="font-size:0.9rem">-</span>
                    </div>
                </div>
            </div>
            <div class="col-3">
                <div class="card text-center text-white bg-success h-100">
                    <div class="card-body p-2">
                        <h6 class="card-title my-0" style="font-size:0.75rem;">ìˆ˜ìµë¥ </h6>
                        <span class="fw-bold" id="resReturn">-</span>
                    </div>
                </div>
            </div>
            <div class="col-3">
                <div class="card text-center text-white bg-danger h-100">
                    <div class="card-body p-2">
                        <h6 class="card-title my-0" style="font-size:0.75rem;">MDD</h6>
                        <span class="fw-bold" id="resMdd">-</span>
                    </div>
                </div>
            </div>
            <div class="col-4">
                <div class="card text-center bg-light">
                    <div class="card-body p-2">
                        <small>ì´ ê±°ë˜</small><br>
                        <span class="fw-bold" id="resTrades">-</span>
                    </div>
                </div>
            </div>
            <div class="col-4">
                <div class="card text-center text-white bg-warning">
                    <div class="card-body p-2">
                        <small>ìŠ¹ë¥ </small><br>
                        <span class="fw-bold" id="resWinRate">-</span>
                    </div>
                </div>
            </div>
            <div class="col-4">
                <div class="card text-center text-white bg-info">
                    <div class="card-body p-2">
                        <small>ì†ìµë¹„</small><br>
                        <span class="fw-bold" id="resProfitFactor">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart -->
        <div class="card mb-3">
            <div class="card-body position-relative p-2">
                <canvas id="equityChart" style="max-height: 250px;"></canvas>
            </div>
        </div>

        <!-- Trade Log -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center py-2">
                <small class="fw-bold">ğŸ“œ ê±°ë˜ ë‚´ì—­</small>
                <form id="csvExportForm" method="POST" action="{% url 'export_backtest_csv' %}" target="_blank">
                    <input type="hidden" name="ticker" id="csvTicker">
                    <input type="hidden" name="capital" id="csvCapital">
                    <input type="hidden" name="strategy_json" id="csvStrategy">
                    <button type="submit" class="btn btn-xs btn-outline-secondary py-0" id="btnDownloadCsv" disabled>
                        ğŸ’¾ CSV
                    </button>
                </form>
            </div>
            <div class="card-body p-0" style="overflow-y: auto; max-height: 250px;">
                <table class="table table-sm table-striped mb-0 text-center" style="font-size: 0.8rem;">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th>ë‚ ì§œ</th>
                            <th>ìœ í˜•</th>
                            <th>ê°€ê²©</th>
                            <th>ìˆ˜ëŸ‰</th>
                        </tr>
                    </thead>
                    <tbody id="tradeLogBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Save Strategy -->
<div class="modal fade" id="saveStrategyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ì „ëµ ì €ì¥í•˜ê¸°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">ì „ëµ ì´ë¦„</label>
                    <input type="text" class="form-control" id="modalStrategyName" placeholder="ì˜ˆ: ë¹„íŠ¸ì½”ì¸ 20ì¼ ì´í‰ ëŒíŒŒ">
                </div>
                <p class="text-muted small">í˜„ì¬ ë¹Œë”ì— ì„¤ì •ëœ ë¡œì§ì´ ì €ì¥ë©ë‹ˆë‹¤.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="confirmSaveStrategy()">ì €ì¥</button>
            </div>
        </div>
    </div>
</div>

<!-- Builder Templates (Hidden) -->
<template id="tpl-logic-node">
    <div class="logic-node border rounded p-2 mb-2 bg-light">
        <div class="d-flex justify-content-between mb-2">
            <select class="form-select form-select-sm w-auto connector-select">
                <option value="AND">AND (ëª¨ë‘)</option>
                <option value="OR">OR (í•˜ë‚˜ë¼ë„)</option>
            </select>
            <div>
                <button type="button" class="btn btn-xs btn-outline-primary add-condition-btn">+ ì¡°ê±´</button>
                <button type="button" class="btn btn-xs btn-outline-dark add-group-btn">+ ê·¸ë£¹</button>
                <button type="button" class="btn btn-xs btn-outline-danger remove-node-btn">X</button>
            </div>
        </div>
        <div class="conditions-container ps-3 border-start border-3"></div>
    </div>
</template>

<template id="tpl-condition-row">
    <div class="condition-row d-flex gap-1 align-items-center mb-1 flex-wrap">
        <select class="form-select form-select-sm lhs-ind" style="width: 110px;">
            <option value="PRICE">ì£¼ê°€ (Close)</option>
            <option value="RSI">RSI</option>
            <option value="SMA">ì´ë™í‰ê· (SMA)</option>
            <option value="EMA">ì§€ìˆ˜í‰ê· (EMA)</option>
        </select>

        <input type="number" class="form-control form-control-sm lhs-param" style="width: 50px;" placeholder="14"
            value="14">

        <select class="form-select form-select-sm operator" style="width: 55px;">
            <option value=">">&gt;</option>
            <option value="<">&lt;</option>
            <option value="=">=</option>
            <option value="CROSS_UP">â¬†ëŒíŒŒ</option>
            <option value="CROSS_DOWN">â¬‡ì´íƒˆ</option>
        </select>

        <select class="form-select form-select-sm rhs-type" style="width: 60px;" onchange="toggleRhsInput(this)">
            <option value="STATIC">ê°’</option>
            <option value="INDICATOR">ì§€í‘œ</option>
        </select>

        <div class="rhs-input-container">
            <input type="number" class="form-control form-control-sm rhs-val" style="width: 60px;" placeholder="30">
        </div>

        <button type="button" class="btn btn-xs btn-outline-danger remove-condition-btn py-0">X</button>
    </div>
</template>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // --- UI & Logic Helpers ---
    const tplNode = document.getElementById('tpl-logic-node');
    const tplCond = document.getElementById('tpl-condition-row');

    function createLogicNode(parentContainer, isRoot = false) {
        const clone = tplNode.content.cloneNode(true);
        const nodeDiv = clone.querySelector('.logic-node');
        const container = clone.querySelector('.conditions-container');
        clone.querySelector('.add-condition-btn').onclick = () => createConditionRow(container);
        clone.querySelector('.add-group-btn').onclick = () => createLogicNode(container);
        const removeBtn = clone.querySelector('.remove-node-btn');
        if (isRoot) removeBtn.remove();
        else removeBtn.onclick = () => nodeDiv.remove();
        parentContainer.appendChild(nodeDiv);
        if (isRoot) createConditionRow(container); // Default
    }

    function createConditionRow(container) {
        const clone = tplCond.content.cloneNode(true);
        const rowDiv = clone.querySelector('.condition-row');
        clone.querySelector('.remove-condition-btn').onclick = () => rowDiv.remove();
        const lhsSel = rowDiv.querySelector('.lhs-ind');
        const lhsParam = rowDiv.querySelector('.lhs-param');
        lhsSel.onchange = () => {
            if (lhsSel.value === 'PRICE') lhsParam.style.display = 'none';
            else lhsParam.style.display = 'block';
        };
        // Initial Trigger
        lhsSel.onchange();
        container.appendChild(rowDiv);
        return rowDiv;
    }

    function toggleRhsInput(selectElem) {
        const row = selectElem.closest('.condition-row');
        const container = row.querySelector('.rhs-input-container');
        const val = selectElem.value;
        container.innerHTML = val === 'STATIC'
            ? '<input type="number" class="form-control form-control-sm rhs-val" style="width: 60px;" placeholder="30">'
            : `<div class="d-flex gap-1">
                 <select class="form-select form-select-sm rhs-ind" style="width: 70px;">
                    <option value="PRICE">ì£¼ê°€</option>
                    <option value="SMA">SMA</option>
                    <option value="EMA">EMA</option>
                 </select>
                 <input type="number" class="form-control form-control-sm rhs-param" style="width: 40px;" value="20">
               </div>`;
    }

    function toggleDCA() {
        const pan = document.getElementById('dcaConfigPanel');
        pan.style.display = document.getElementById('dcaEnabled').checked ? 'block' : 'none';
    }

    function resetStrategy() {
        document.getElementById('buyLogicContainer').innerHTML = '';
        document.getElementById('sellLogicContainer').innerHTML = '';
        createLogicNode(document.getElementById('buyLogicContainer'), true);

        // Reset ID/Name
        document.getElementById('currentStrategyId').value = '';
        document.getElementById('currentStrategyLabel').style.display = 'none';
        document.getElementById('strategyNameInput').value = '';
    }

    // --- JSON Parser/Builder ---
    function parseLogicNode(nodeDiv) {
        const connector = nodeDiv.querySelector('.connector-select').value;
        const container = nodeDiv.querySelector('.conditions-container');
        const conditions = [];
        for (let child of container.children) {
            if (child.classList.contains('logic-node')) conditions.push(parseLogicNode(child));
            else if (child.classList.contains('condition-row')) conditions.push(parseCondition(child));
        }
        return { connector: connector, conditions: conditions };
    }

    function parseCondition(row) {
        const lhsInd = row.querySelector('.lhs-ind').value;
        const lhsParamVal = row.querySelector('.lhs-param').value;
        const operator = row.querySelector('.operator').value;
        const rhsType = row.querySelector('.rhs-type').value;
        let rhsVal;
        if (rhsType === 'STATIC') {
            rhsVal = parseFloat(row.querySelector('.rhs-val').value) || 0;
        } else {
            const rhsIndName = row.querySelector('.rhs-ind').value;
            const rhsParamVal = row.querySelector('.rhs-param').value;
            rhsVal = { name: rhsIndName, params: { period: parseInt(rhsParamVal) } };
        }
        return {
            indicator: { name: lhsInd, params: { period: parseInt(lhsParamVal) || 0 } },
            operator: operator,
            value_type: rhsType,
            value: rhsVal
        };
    }

    function buildStrategyJson() {
        const buyRoot = document.getElementById('buyLogicContainer').firstElementChild;
        const buyLogic = buyRoot ? parseLogicNode(buyRoot) : null;
        const sellRoot = document.getElementById('sellLogicContainer').firstElementChild;
        let sellLogic = null;
        if (sellRoot) sellLogic = parseLogicNode(sellRoot);

        const dcaEnabled = document.getElementById('dcaEnabled').checked;
        return {
            buy_conditions: buyLogic,
            sell_conditions: sellLogic,
            dca_config: {
                enabled: dcaEnabled,
                type: document.getElementById('dcaType').value,
                amount: parseFloat(document.getElementById('dcaAmount').value),
                interval: document.getElementById('dcaInterval').value
            }
        };
    }

    // --- JSON Logic Loader (Reconstruction) ---
    function renderLogic(container, logicData) {
        container.innerHTML = '';
        if (!logicData) return;
        renderLogicNodeRecursive(container, logicData, true);
    }

    function renderLogicNodeRecursive(container, logicNode, isRoot) {
        // Create Node
        createLogicNode(container, false); // Add fake first, then clean
        // The helper `createLogicNode` appends. We get the last child.
        const nodeDiv = container.lastElementChild;

        // Remove the default condition added by helper for non-root, or keep for root? 
        // Our helper helper adds a default condition if isRoot only. 
        // Logic: clear automatically added stuff and rebuild.
        const condContainer = nodeDiv.querySelector('.conditions-container');
        condContainer.innerHTML = '';

        // Set Connector
        nodeDiv.querySelector('.connector-select').value = logicNode.connector || 'AND';

        // Root check logic adjustment
        if (isRoot) {
            // Helper handles root removal button check
            const removeBtn = nodeDiv.querySelector('.remove-node-btn');
            if (removeBtn) removeBtn.remove();
        }

        // Render Children
        if (logicNode.conditions && logicNode.conditions.length > 0) {
            logicNode.conditions.forEach(child => {
                if (child.connector) {
                    // It's a group
                    renderLogicNodeRecursive(condContainer, child, false);
                } else {
                    // It's a condition
                    renderConditionRow(condContainer, child);
                }
            });
        }
    }

    function renderConditionRow(container, condData) {
        const rowDiv = createConditionRow(container);

        // LHS
        const lhsSel = rowDiv.querySelector('.lhs-ind');
        const lhsParam = rowDiv.querySelector('.lhs-param');
        lhsSel.value = condData.indicator.name;
        lhsParam.value = condData.indicator.params.period || 14;
        lhsSel.onchange(); // trigger display

        // Operator
        rowDiv.querySelector('.operator').value = condData.operator;

        // RHS
        const rhsTypeSel = rowDiv.querySelector('.rhs-type');
        rhsTypeSel.value = condData.value_type;
        toggleRhsInput(rhsTypeSel); // Build DOM

        const rhsContainer = rowDiv.querySelector('.rhs-input-container');
        if (condData.value_type === 'STATIC') {
            rhsContainer.querySelector('.rhs-val').value = condData.value;
        } else {
            rhsContainer.querySelector('.rhs-ind').value = condData.value.name;
            rhsContainer.querySelector('.rhs-param').value = condData.value.params.period;
        }
    }


    // --- CRUD Operations ---
    async function showSaveModal() {
        const id = document.getElementById('currentStrategyId').value;
        if (id) {
            // If editing, use existing name
            // But we need to fetch name? it's in input
            document.getElementById('modalStrategyName').value = document.getElementById('strategyNameInput').value;
        } else {
            document.getElementById('modalStrategyName').value = '';
        }
        new bootstrap.Modal(document.getElementById('saveStrategyModal')).show();
    }

    async function confirmSaveStrategy() {
        const name = document.getElementById('modalStrategyName').value;
        if (!name) return alert("ì „ëµ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        const id = document.getElementById('currentStrategyId').value;
        const logic = buildStrategyJson();
        const ticker = document.getElementById('stockSelect').value; // Save context

        try {
            const resp = await fetch('/core/strategy/save/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ strategy_id: id, name: name, logic: logic, ticker: ticker })
            });
            const res = await resp.json();
            if (res.success) {
                alert(res.message);
                location.reload(); // Simple reload to refresh list
            } else {
                alert("Error: " + res.error);
            }
        } catch (e) {
            alert("Error: " + e.message);
        }
    }

    async function loadStrategy(id) {
        try {
            const resp = await fetch(`/core/strategy/${id}/load/`);
            const res = await resp.json();
            if (res.success) {
                const data = res.data;
                // Set Meta
                document.getElementById('currentStrategyId').value = data.id;
                document.getElementById('strategyNameInput').value = data.name;
                document.getElementById('currentStrategyLabel').innerText = "í¸ì§‘ ì¤‘: " + data.name;
                document.getElementById('currentStrategyLabel').style.display = 'inline-block';

                // Select Ticker if exists
                if (data.ticker) {
                    const sel = document.getElementById('stockSelect');
                    if (sel.querySelector(`option[value="${data.ticker}"]`)) sel.value = data.ticker;
                }

                // Render Logic
                const logic = data.logic || {};

                // Reset containers
                document.getElementById('buyLogicContainer').innerHTML = '';
                document.getElementById('sellLogicContainer').innerHTML = '';

                // Render Buy
                if (logic.buy_conditions) {
                    renderLogicNodeRecursive(document.getElementById('buyLogicContainer'), logic.buy_conditions, true);
                } else {
                    createLogicNode(document.getElementById('buyLogicContainer'), true); // Default
                }

                // Render Sell
                if (logic.sell_conditions) {
                    renderLogicNodeRecursive(document.getElementById('sellLogicContainer'), logic.sell_conditions, true);
                }

                // DCA
                if (logic.dca_config) {
                    document.getElementById('dcaEnabled').checked = logic.dca_config.enabled;
                    toggleDCA();
                    document.getElementById('dcaType').value = logic.dca_config.type;
                    document.getElementById('dcaAmount').value = logic.dca_config.amount;
                    document.getElementById('dcaInterval').value = logic.dca_config.interval;
                }

                alert(`'${data.name}' ì „ëµì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);

            } else {
                alert("Error: " + res.error);
            }
        } catch (e) { console.error(e); alert("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨"); }
    }

    async function deleteStrategy(id, event) {
        event.stopPropagation();
        if (!confirm("ì •ë§ ì´ ì „ëµì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        try {
            const resp = await fetch(`/core/strategy/${id}/delete/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token }}' }
            });
            const res = await resp.json();
            if (res.success) {
                document.getElementById(`strategy-row-${id}`).remove();
                // If current, reset?
                if (document.getElementById('currentStrategyId').value == id) resetStrategy();
            } else {
                alert("ì‚­ì œ ì‹¤íŒ¨: " + res.error);
            }
        } catch (e) { alert("ì‚­ì œ ì˜¤ë¥˜"); }
    }

    // --- Backtest Runner ---
    let myChart = null;
    async function runBacktest() {
        const strategy = buildStrategyJson();
        const stockCode = document.getElementById('stockSelect').value;
        const capital = document.getElementById('initialCapital').value;
        if (!stockCode) return alert("ì¢…ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

        const btn = document.querySelector('.btn-success');
        const oldText = btn.innerText;
        btn.innerText = "â³ ê³„ì‚° ì¤‘...";
        btn.disabled = true;

        try {
            const resp = await fetch('/core/backtest/run/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ ticker: stockCode, capital: capital, strategy: strategy })
            });
            const res = await resp.json();
            if (!res.success) throw new Error(res.error || "Unknown Error");
            updateDashboard(res.data);
        } catch (e) {
            alert("ë°±í…ŒìŠ¤íŒ… ì‹¤íŒ¨: " + e.message);
        } finally {
            btn.innerText = oldText;
            btn.disabled = false;
        }
    }

    function updateDashboard(data) {
        const stats = document.getElementById('resultStats');
        stats.style.display = 'flex';
        document.getElementById('resFinalCapital').innerText = Number(data.final_equity).toLocaleString() + "ì›";
        document.getElementById('resReturn').innerText = data.total_return.toFixed(2) + "%";
        document.getElementById('resMdd').innerText = data.mdd.toFixed(2) + "%";
        document.getElementById('resTrades').innerText = data.trades.length + "íšŒ";
        document.getElementById('resWinRate').innerText = (data.win_rate || 0).toFixed(1) + "%";
        document.getElementById('resProfitFactor').innerText = (data.profit_factor || 0).toFixed(2);

        // CSV Setup
        document.getElementById('csvTicker').value = document.getElementById('stockSelect').value;
        document.getElementById('csvCapital').value = document.getElementById('initialCapital').value;
        document.getElementById('csvStrategy').value = JSON.stringify(buildStrategyJson());
        document.getElementById('btnDownloadCsv').disabled = false;

        // Chart
        const ctx = document.getElementById('equityChart').getContext('2d');
        if (myChart) myChart.destroy();

        const labels = data.equity_curve.map(d => d.date);
        const equity = data.equity_curve.map(d => d.equity);

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'ìì‚°', data: equity, borderColor: '#3b82f6', tension: 0.1, pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                interaction: { intersect: false, mode: 'index' }
            }
        });

        // Log
        const tbody = document.getElementById('tradeLogBody');
        tbody.innerHTML = '';
        data.trades.forEach(t => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${t.date.slice(2)}</td>
                <td class="${t.type.includes('BUY') ? 'text-danger' : 'text-primary'} fw-bold">${t.type}</td>
                <td>${Number(t.price).toLocaleString()}</td>
                <td>${t.quantity}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // Init
    window.onload = function () {
        createLogicNode(document.getElementById('buyLogicContainer'), true);
    };
</script>
{% endblock %}