{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<style>
    .dashboard-container {
        padding: 30px;
        background-color: #f1f5f9;
        min-height: 100vh;
    }

    .modern-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        border: 1px solid #e2e8f0;
        margin-bottom: 20px;
    }

    /* Modal Styles */
    .modal-stock-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
</style>

<div class="dashboard-container">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-dark m-0">ğŸ“© ì²´ê²° ì•Œë¦¼ ë‚´ì—­</h2>
        
        <!-- Filter/Sort Toolbar -->
        <div class="btn-group">
            <a href="?sort=time&direction=desc"
                class="btn btn-outline-secondary btn-sm {% if current_sort == 'time' and current_direction == 'desc' %}active{% endif %}">ìµœì‹ ìˆœ</a>
            <a href="?sort=time&direction=asc"
                class="btn btn-outline-secondary btn-sm {% if current_sort == 'time' and current_direction == 'asc' %}active{% endif %}">ê³¼ê±°ìˆœ</a>
        </div>
    </div>

    <!-- Notification Table -->
    <div class="modern-card border-0 shadow-sm" style="overflow: hidden;">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4 py-3 text-secondary border-0" style="font-weight: 600;">ìˆ˜ì‹  ì¼ì‹œ</th>
                        <th class="py-3 text-secondary border-0 text-center" style="font-weight: 600;">êµ¬ë¶„</th>
                        <th class="py-3 text-secondary border-0" style="font-weight: 600;">ì¢…ëª© ì •ë³´</th>
                        <th class="py-3 text-secondary border-0 text-end" style="font-weight: 600;">ì²´ê²° ë‚´ì—­</th>
                        <th class="py-3 text-secondary border-0 text-end" style="font-weight: 600;">ì´ ê¸ˆì•¡</th>
                        <th class="pe-4 py-3 text-secondary border-0 text-center" style="font-weight: 600;">ìƒíƒœ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for noti in notifications %}
                    <tr>
                        <!-- Time -->
                        <td class="ps-4 py-3 text-muted" style="font-size: 14px;">
                            {{ noti.created_at|date:"Y-m-d" }}<br>
                            <span class="small">{{ noti.created_at|date:"H:i:s" }}</span>
                        </td>

                        <!-- Trade Type Badge -->
                        <td class="py-3 text-center">
                            {% if noti.trade_type == 'buy' %}
                            <span class="badge bg-danger-subtle text-danger border border-danger-subtle">ë§¤ìˆ˜</span>
                            {% elif noti.trade_type == 'sell' %}
                            <span class="badge bg-primary-subtle text-primary border border-primary-subtle">ë§¤ë„</span>
                            {% else %}
                            <span class="badge bg-secondary-subtle text-secondary">ê¸°íƒ€</span>
                            {% endif %}
                        </td>

                        <!-- Stock Info -->
                        <td class="py-3">
                            <div class="fw-bold text-dark">{{ noti.stock_name|default:"-" }}</div>
                            <div class="text-secondary small">{{ noti.stock_code|default:"-" }}</div>
                        </td>

                        <!-- Trade Details -->
                        <td class="py-3 text-end">
                            <div class="fw-bold">{{ noti.quantity|intcomma }}ì£¼</div>
                            <div class="text-muted small">@ {{ noti.price|intcomma }}</div>
                        </td>

                        <!-- Total Amount -->
                        <td class="py-3 text-end">
                            <span class="fw-bold fs-6 {% if noti.trade_type == 'buy' %}text-danger{% else %}text-primary{% endif %}">
                                {{ noti.amount|intcomma }}ì›
                            </span>
                        </td>

                        <!-- Status & Action -->
                        <td class="pe-4 py-3 text-center">
                            {% if not noti.is_parsed %}
                            <button class="btn btn-sm btn-outline-warning rounded-pill px-3" onclick="openSmsModal(this)"
                                data-content="{{ noti.content }}" data-date="{{ noti.created_at|date:'Y-m-d H:i' }}">
                                <i class="fas fa-exclamation-triangle me-1"></i> í™•ì¸ í•„ìš”
                            </button>
                            {% else %}
                            <button class="btn btn-sm btn-outline-secondary rounded-pill px-3" onclick="openSmsModal(this)"
                                data-content="{{ noti.content }}" data-date="{{ noti.created_at|date:'Y-m-d H:i' }}">
                                ì›ë³¸
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center py-5 text-muted">
                            <span style="font-size: 30px;">ğŸ“­</span> <br>
                            ìˆ˜ì‹ ëœ ì²´ê²° ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Raw SMS Modal -->
<div class="modal fade" id="smsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 20px; border:none;">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">ğŸ“¨ SMS ì›ë³¸ ë‚´ìš©</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="d-flex justify-content-between mb-2">
                    <span class="badge bg-light text-dark border" id="modalDate">-</span>
                </div>
                <div class="p-3 bg-light rounded text-break text-secondary" id="modalContent" style="min-height: 100px; white-space: pre-wrap;">
                    <!-- Content -->
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-secondary rounded-pill w-100" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<script>
    function openSmsModal(btn) {
        const content = btn.getAttribute('data-content');
        const date = btn.getAttribute('data-date');
        
        document.getElementById('modalContent').innerText = content;
        document.getElementById('modalDate').innerText = date;
        
        const modal = new bootstrap.Modal(document.getElementById('smsModal'));
        modal.show();
    }
</script>
{% endblock %}