{% extends "base.html" %}
{% load humanize %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    .dashboard-container {
        padding: 30px;
        background-color: #f1f5f9;
        min-height: 100vh;
    }

    .modern-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        border: 1px solid #e2e8f0;
        margin-bottom: 20px;
        transition: 0.2s;
        cursor: pointer;
    }

    .modern-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    .card-header-modern {
        padding: 20px 25px;
        font-weight: 700;
        font-size: 16px;
        color: #334155;
        border-bottom: 1px solid #f1f5f9;
    }

    .search-input {
        padding: 12px 20px;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        width: 100%;
        max-width: 400px;
        font-size: 14px;
        outline: none;
        transition: 0.2s;
    }

    .search-input:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* Modal Styles */
    .modal-stock-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .metric-card {
        background: #f8fafc;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
    }

    .metric-label {
        font-size: 12px;
        color: #64748b;
        margin-bottom: 4px;
    }

    .metric-value {
        font-size: 16px;
        font-weight: 700;
        color: #1e293b;
    }
</style>

<div class="dashboard-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-dark m-0">ğŸ“Š ì¢…ëª© ê´€ë¦¬</h2>
        <div class="d-flex gap-2">
            <button onclick="updateAllStocks(this)" class="btn btn-primary btn-sm rounded-pill px-3 shadow-sm">
                <i class="fas fa-sync-alt me-1"></i> ì „ ì¢…ëª© ì‹œì„¸ ì—…ë°ì´íŠ¸
            </button>
            <button id="toggleOrderBtn" class="btn btn-outline-secondary btn-sm rounded-pill px-3"
                onclick="toggleOrderMode()">
                <i class="fas fa-sort me-1"></i> ìˆœì„œ ë³€ê²½
            </button>
        </div>
        <div id="saveOrderControls" class="d-none align-items-center">
            <span class="text-primary fw-bold me-3 small"><i class="fas fa-check-circle"></i> ìë™ ì €ì¥ ë¨</span>
            <div class="btn-group me-2">
                <button class="btn btn-outline-secondary btn-sm" onclick="moveSelectedRow('top')" title="ë§¨ ìœ„ë¡œ"><i
                        class="fas fa-angle-double-up"></i></button>
                <button class="btn btn-outline-secondary btn-sm" onclick="moveSelectedRow('up')" title="ìœ„ë¡œ"><i
                        class="fas fa-chevron-up"></i></button>
                <button class="btn btn-outline-secondary btn-sm" onclick="moveSelectedRow('down')" title="ì•„ë˜ë¡œ"><i
                        class="fas fa-chevron-down"></i></button>
                <button class="btn btn-outline-secondary btn-sm" onclick="moveSelectedRow('bottom')" title="ë§¨ ì•„ë˜ë¡œ"><i
                        class="fas fa-angle-double-down"></i></button>
            </div>
            <button class="btn btn-outline-primary btn-sm rounded-pill px-3" onclick="toggleOrderMode()">ì™„ë£Œ</button>
        </div>
    </div>

    <!-- Search & Add (Autocomplete) -->
    <div class="mb-5 text-center position-relative">
        <form action="{% url 'add_interest_stock' %}" method="post" class="d-inline-block w-100"
            style="max-width: 500px;">
            {% csrf_token %}
            <div class="d-flex justify-content-center gap-2 position-relative">
                <!-- Visible Input -->
                <input type="text" id="stockSearchInput" class="search-input" placeholder="ì¢…ëª©ëª… ì…ë ¥ (ì˜ˆ: ì‚¼ì„±ì „ì, Apple)..."
                    autocomplete="off">

                <!-- Hidden Input -->
                <input type="hidden" name="keyword" id="stockCodeInput">

                <button type="submit" class="btn btn-primary px-4 fw-bold"
                    style="border-radius: 12px; height: 46px;">ì¶”ê°€</button>
            </div>

            <!-- Autocomplete Dropdown -->
            <ul id="autocompleteList" class="autocomplete-list"></ul>
        </form>
    </div>

    <!-- Stock List (Table View) -->
    <div class="card border-0 shadow-sm" style="border-radius: 16px; overflow: hidden;">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4 py-3 text-secondary border-0 drag-col d-none" style="width: 50px;"></th>
                        <!-- Drag Handle Col -->
                        <th class="ps-4 py-3 text-secondary border-0" style="font-weight: 600;">
                            <a href="?sort=name&direction={% if current_sort == 'name' and current_direction == 'asc' %}desc{% elif current_sort == 'name' and current_direction == 'desc' %}{% else %}asc{% endif %}"
                                class="text-decoration-none {% if current_sort == 'name' %}text-primary fw-bold{% else %}text-secondary{% endif %}">
                                ì¢…ëª©ëª…
                                {% if current_sort == 'name' %}
                                {% if current_direction == 'asc' %}â–²{% else %}â–¼{% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th class="py-3 text-secondary border-0" style="font-weight: 600;">
                            <a href="?sort=price&direction={% if current_sort == 'price' and current_direction == 'asc' %}desc{% elif current_sort == 'price' and current_direction == 'desc' %}{% else %}asc{% endif %}"
                                class="text-decoration-none {% if current_sort == 'price' %}text-primary fw-bold{% else %}text-secondary{% endif %}">
                                í˜„ì¬ê°€
                                {% if current_sort == 'price' %}
                                {% if current_direction == 'asc' %}â–²{% else %}â–¼{% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th class="py-3 text-secondary border-0 text-center" style="font-weight: 600;">
                            <a href="?sort=country&direction={% if current_sort == 'country' and current_direction == 'asc' %}desc{% elif current_sort == 'country' and current_direction == 'desc' %}{% else %}asc{% endif %}"
                                class="text-decoration-none {% if current_sort == 'country' %}text-primary fw-bold{% else %}text-secondary{% endif %}">
                                êµ­ê°€
                                {% if current_sort == 'country' %}
                                {% if current_direction == 'asc' %}â–²{% else %}â–¼{% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th class="pe-4 py-3 text-secondary border-0 text-end" style="font-weight: 600;">ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="stockTableBody" hx-post="{% url 'update_stock_ordering' %}" hx-trigger="newOrder"
                    hx-target="this" hx-swap="none" hx-include="#stockTableBody input">
                    {% for stock in stocks %}
                    <tr style="cursor: pointer;" onclick="openStockDetail({{ stock.id }})" data-id="{{ stock.id }}">
                        <!-- Drag Handle -->
                        <td class="ps-4 py-3 text-center drag-col d-none" onclick="event.stopPropagation();">
                            <input type="hidden" name="order" value="{{ stock.id }}">
                            <i class="fas fa-bars drag-handle"></i>
                        </td>

                        <!-- Name & Code -->
                        <td class="ps-4 py-3">
                            <div class="fw-bold text-dark">
                                {% if stock.is_held %}
                                <i class="fas fa-circle text-success me-1"
                                    style="font-size: 8px; vertical-align: middle;"></i>
                                {% else %}
                                <i class="fas fa-circle text-warning me-1"
                                    style="font-size: 8px; vertical-align: middle;"></i>
                                {% endif %}
                                {{ stock.name }}
                            </div>
                            <div class="text-secondary small">{{ stock.code }}</div>
                        </td>

                        <!-- Price -->
                        <td class="py-3">
                            <span class="fw-bold text-primary fs-5">
                                {% if stock.is_korean %}
                                {{ stock.current_price|default:0|floatformat:0|intcomma }}ì›
                                {% else %}
                                {{ stock.current_price|default:0|floatformat:2|intcomma }}$
                                {% endif %}
                            </span>
                        </td>

                        <!-- Country Badge -->
                        <td class="py-3 text-center">
                            <span class="badge bg-light text-dark border">{{ stock.country|default:"ë¯¸êµ­" }}</span>
                        </td>

                        <!-- Delete Action -->
                        <td class="pe-4 py-3 text-end" onclick="event.stopPropagation();">
                            <form action="{% url 'delete_interest_stock' stock.id %}" method="post"
                                class="d-inline-block" onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-outline-danger rounded-pill px-3">
                                    ì‚­ì œ
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center py-5 text-muted">
                            <span style="font-size: 40px;">ğŸ”­</span> <br>
                            ë“±ë¡ëœ ê´€ì‹¬ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤. ìƒë‹¨ ê²€ìƒ‰ì°½ì„ í†µí•´ ì¢…ëª©ì„ ì¶”ê°€í•´ë³´ì„¸ìš”.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Stock Detail Modal -->
<div class="modal fade" id="stockDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content" style="border-radius: 20px; border:none;">
            <div class="modal-body p-5">
                <!-- Header -->
                <div class="modal-stock-header">
                    <div>
                        <h2 class="fw-bold m-0" id="modalStockName">ì¢…ëª©ëª…</h2>
                        <span class="text-muted" id="modalStockCode">000000</span>
                    </div>
                    <div class="text-end">
                        <h2 class="fw-bold text-primary m-0" id="modalPrice">0ì›</h2>
                        <span class="badge bg-success" id="modalBadge">ì‹¤ì‹œê°„</span>
                    </div>
                </div>

                <!-- Metrics: Updated Layout -->
                <div class="row mb-4 g-3">
                    <div class="col-md-4">
                        <div class="metric-card">
                            <div class="metric-label">ì‹œê°€ì´ì•¡</div>
                            <div class="metric-value" id="modalMarketCap">-</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="metric-card">
                            <div class="metric-label">52ì£¼ ìµœê³ </div>
                            <div class="metric-value" id="modalHigh52">-</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="metric-card">
                            <div class="metric-label">52ì£¼ ìµœì €</div>
                            <div class="metric-value" id="modalLow52">-</div>
                        </div>
                    </div>
                </div>

                <!-- Chart -->
                <div id="stockChart" style="height: 400px; width:100%;"></div>

                <!-- Description -->
                <div class="mt-4 p-4 bg-light rounded-3">
                    <h6 class="fw-bold mb-2">ê¸°ì—… ê°œìš”</h6>
                    <p class="text-secondary small m-0" id="modalDescription" style="line-height: 1.6;">
                        ë¡œë”© ì¤‘...
                    </p>
                </div>

                <div class="text-end mt-4">
                    <button type="button" class="btn btn-secondary rounded-pill px-4"
                        data-bs-dismiss="modal">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ApexCharts -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<script>
    let chart = null;
    let isOrderMode = false;
    let selectedRow = null; // [NEW] Track selected row

    function openStockDetail(stockId) {
        // [NEW] Check flag & Handle Selection
        if (isOrderMode) {
            handleRowSelection(stockId);
            return;
        }

        // Show Modal
        const modal = new bootstrap.Modal(document.getElementById('stockDetailModal'));
        modal.show();

        // Reset values
        document.getElementById('modalMarketCap').innerText = '-';
        document.getElementById('modalHigh52').innerText = '-';
        document.getElementById('modalLow52').innerText = '-';
        document.getElementById('modalDescription').innerText = 'ë¡œë”© ì¤‘...';

        // Load Data
        fetch(`{% url 'get_stock_detail' %}?stock_id=${stockId}`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // Update Info
                    document.getElementById('modalStockName').innerText = data.name;
                    document.getElementById('modalStockCode').innerText = data.code;

                    // Currency Formatting Logic
                    const price = Number(data.price);
                    const high52 = Number(data.high_52w || 0);
                    const low52 = Number(data.low_52w || 0);

                    // Check if it's a Korean stock (6 digits)
                    const isKorean = /^\d{6}$/.test(data.code);

                    if (isKorean) {
                        document.getElementById('modalPrice').innerText = price.toLocaleString() + 'ì›';
                        document.getElementById('modalHigh52').innerText = high52.toLocaleString() + "ì›";
                        document.getElementById('modalLow52').innerText = low52.toLocaleString() + "ì›";
                    } else {
                        document.getElementById('modalPrice').innerText = price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + '$';
                        document.getElementById('modalHigh52').innerText = high52.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "$";
                        document.getElementById('modalLow52').innerText = low52.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "$";
                    }

                    // Market Cap Formatting (Jo/Eok)
                    let capStr = "-";
                    if (data.market_cap) {
                        const cap = data.market_cap;
                        const TRILLION = 1000000000000;
                        const HUNDRED_MILLION = 100000000;

                        if (cap >= TRILLION) {
                            capStr = (cap / TRILLION).toFixed(2) + "ì¡°ì›";
                        } else {
                            capStr = Math.round(cap / HUNDRED_MILLION).toLocaleString() + "ì–µì›";
                        }
                    }
                    document.getElementById('modalMarketCap').innerText = capStr;

                    document.getElementById('modalDescription').innerText = data.description || "ì •ë³´ ì—†ìŒ";

                    // Render Chart
                    renderChart(data.candles, data.name);
                }
            });
    }

    function renderChart(candles, name) {
        if (chart) {
            chart.destroy();
        }

        const options = {
            series: [{
                data: candles
            }],
            chart: {
                type: 'candlestick',
                height: 350,
                fontFamily: 'Pretendard, sans-serif'
            },
            title: {
                text: name + ' (3ë…„ / ì£¼ë´‰)',
                align: 'left'
            },
            xaxis: {
                type: 'datetime'
            },
            yaxis: {
                tooltip: {
                    enabled: true
                },
                labels: {
                    formatter: function (value) {
                        return Math.round(value).toLocaleString();
                    }
                }
            },
            plotOptions: {
                candlestick: {
                    colors: {
                        upward: '#ef4444',
                        downward: '#3b82f6'
                    }
                }
            }
        };

        chart = new ApexCharts(document.querySelector("#stockChart"), options);
        chart.render();
    }
</script>

<style>
    /* Autocomplete Styles */
    .autocomplete-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1000;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        list-style: none;
        padding: 0;
        margin: 5px auto;
        max-width: 500px;
        /* Match form width */
        max-height: 300px;
        overflow-y: auto;
        text-align: left;
        display: none;
        /* Hidden by default */
    }

    .autocomplete-item {
        padding: 12px 20px;
        cursor: pointer;
        border-bottom: 1px solid #f1f5f9;
        transition: 0.1s;
    }

    .autocomplete-item:last-child {
        border-bottom: none;
    }

    .autocomplete-item:hover {
        background-color: #f8fafc;
        color: #3b82f6;
    }

    .item-name {
        font-weight: 600;
        color: #1e293b;
    }

    .item-code {
        font-size: 12px;
        color: #64748b;
        margin-left: 8px;
    }

    /* Order Mode Selection */
    .selected-row {
        background-color: #fef9c3 !important;
        /* Light Yellow */
        border: 2px solid #f59e0b;
    }
</style>

<!-- SortableJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<!-- HTMX -->
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<script>
    let sortableInstance = null;

    function toggleOrderMode() {
        const tbody = document.getElementById('stockTableBody');
        const btn = document.getElementById('toggleOrderBtn');
        const controls = document.getElementById('saveOrderControls');
        const dragCols = document.querySelectorAll('.drag-col');

        if (isOrderMode) {
            // Disable Mode (Click 'Done')
            isOrderMode = false;
            selectedRow = null;
            btn.classList.remove('d-none');
            controls.classList.add('d-none');
            dragCols.forEach(col => col.classList.add('d-none'));
            document.querySelectorAll('.selected-row').forEach(row => row.classList.remove('selected-row'));

            // Reload to clear state (cleanest way to exit "edit mode" visually)
            location.reload();
        } else {
            // Enable Mode
            isOrderMode = true;
            btn.classList.add('d-none');
            controls.classList.remove('d-none');
            dragCols.forEach(col => col.classList.remove('d-none'));

            // Init Sortable with Event Trigger
            if (tbody && !sortableInstance) {
                sortableInstance = new Sortable(tbody, {
                    animation: 150,
                    handle: '.drag-handle',
                    ghostClass: 'sortable-ghost',
                    onEnd: function () {
                        // Trigger HTMX request
                        tbody.dispatchEvent(new Event('newOrder'));
                    }
                });
            }
        }
    }

    function cancelOrderMode() {
        location.reload();
    }

    function handleRowSelection(stockId) {
        const row = document.querySelector(`tr[data-id="${stockId}"]`);
        if (!row) return;

        if (selectedRow === row) {
            selectedRow.classList.remove('selected-row');
            selectedRow = null;
        } else {
            if (selectedRow) selectedRow.classList.remove('selected-row');
            selectedRow = row;
            selectedRow.classList.add('selected-row');
        }
    }

    function moveSelectedRow(direction) {
        if (!selectedRow) {
            alert('ì´ë™í•  ì¢…ëª©ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        const tbody = document.getElementById('stockTableBody');
        let changed = false;

        if (direction === 'up') {
            const prev = selectedRow.previousElementSibling;
            if (prev) { tbody.insertBefore(selectedRow, prev); changed = true; }
        } else if (direction === 'down') {
            const next = selectedRow.nextElementSibling;
            if (next) { tbody.insertBefore(next, selectedRow); changed = true; }
        } else if (direction === 'top') {
            tbody.prepend(selectedRow); changed = true;
        } else if (direction === 'bottom') {
            tbody.append(selectedRow); changed = true;
        }

        selectedRow.scrollIntoView({ behavior: 'smooth', block: 'center' });

        if (changed) {
            // Trigger HTMX request
            tbody.dispatchEvent(new Event('newOrder'));
        }
    }
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const input = document.getElementById('stockSearchInput');
        const hiddenInput = document.getElementById('stockCodeInput');
        const list = document.getElementById('autocompleteList');
        let debounceTimer;

        // Input Event (Debounced)
        input.addEventListener('input', function () {
            const query = this.value.trim();
            if (query.length < 1) {
                list.style.display = 'none';
                return;
            }

            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                fetch(`{% url 'search_stock_api' %}?q=${encodeURIComponent(query)}`)
                    .then(res => res.json())
                    .then(data => {
                        renderList(data.quotes);
                    });
            }, 300);
        });

        // Render List
        function renderList(quotes) {
            list.innerHTML = '';
            if (!quotes || quotes.length === 0) {
                list.style.display = 'none';
                return;
            }

            quotes.forEach(q => {
                const li = document.createElement('li');
                li.className = 'autocomplete-item';
                li.innerHTML = `
                    <span class="item-name">${q.name}</span>
                    <span class="item-code">${q.symbol}</span>
                    <span class="badge bg-light text-secondary ms-2">${q.exch}</span>
                `;

                li.addEventListener('click', () => {
                    input.value = `${q.name} (${q.symbol})`; // Show fancy text
                    hiddenInput.value = q.symbol; // Submit real code
                    list.style.display = 'none';
                });

                list.appendChild(li);
            });
            list.style.display = 'block';
        }

        // Close on outside click
        document.addEventListener('click', function (e) {
            if (!input.contains(e.target) && !list.contains(e.target)) {
                list.style.display = 'none';
            }
        });
    });
</script>

</div>

<script>
    function updateAllStocks(btn) {
        if (!confirm('ì „ ì¢…ëª©ì˜ ì‹œì„¸(í˜„ì¬ê°€, 52ì£¼ ë“±)ì™€ ìº”ë“¤ ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‹œê°„ì´ ë‹¤ì†Œ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.')) return;

        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> ì—…ë°ì´íŠ¸ ì¤‘...';

        fetch('/api/stock/update/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('ì˜¤ë¥˜: ' + data.message);
                }
            })
            .catch(error => {
                alert('ì„œë²„ ì˜¤ë¥˜ ë°œìƒ');
                console.error(error);
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalText;
            });
    }
</script>
{% endblock %}