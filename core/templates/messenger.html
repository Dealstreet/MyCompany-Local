{% extends 'base.html' %}
{% block content %}
<style>
    .chat-container { flex: 1; display: flex; flex-direction: column; background-color: #f2f5f9; height: 100vh; }
    .chat-header { height: 60px; background-color: white; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; padding: 0 25px; font-weight: 700; color: #1e293b; }
    .chat-box { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
    .message-row { display: flex; width: 100%; }
    .sent { justify-content: flex-end; }
    .received { justify-content: flex-start; }
    .bubble { padding: 14px 18px; border-radius: 12px; font-size: 15px; line-height: 1.5; box-shadow: 0 1px 3px rgba(0,0,0,0.05); width: fit-content; max-width: 70%; word-break: break-word; }
    .sent .bubble { background-color: #3b82f6; color: white; border-top-right-radius: 2px; }
    .received .bubble { background-color: white; border: 1px solid #e2e8f0; border-top-left-radius: 2px; }
</style>

<div class="chat-container">
    <div class="chat-header">
        {% if active_agent %}
            {{ active_agent.department }} {{ active_agent.name }} {{ active_agent.position }}
        {% else %}
            ëŒ€í™”í•  ì§ì›ì„ ì„ íƒí•´ ì£¼ì„¸ìš”
        {% endif %}
    </div>

    <div class="chat-box" id="chatBox">
        {% for msg in messages %}
        <div class="message-row {% if msg.role == 'user' %}sent{% else %}received{% endif %}">
            <div class="bubble">{{ msg.content|linebreaksbr }}</div>
        </div>
        {% endfor %}
    </div>
    
    <div class="p-3 bg-white border-top">
        {% if active_agent %}
        <div class="d-flex gap-2 mb-2">
            <button class="btn btn-outline-primary btn-sm" onclick="applyForm('buy')">ğŸ“ˆ ë§¤ìˆ˜ì§€ì‹œ</button>
            <button class="btn btn-outline-danger btn-sm" onclick="applyForm('sell')">ğŸ“‰ ë§¤ë„ì§€ì‹œ</button>
            <button class="btn btn-outline-success btn-sm" onclick="applyForm('perf')">ğŸ“Š ì„±ê³¼ë³´ê³ </button>
            <button class="btn btn-outline-dark btn-sm" onclick="applyForm('market')">ğŸŒ ì‹œì¥ë³´ê³ </button>
        </div>
        {% endif %}

        <form method="post" class="d-flex gap-2">
            {% csrf_token %}
            <input type="text" name="message" id="msgInput" class="form-control" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ìœ„ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”..." required>
            <button type="submit" class="btn btn-primary" style="min-width: 80px;">ì „ì†¡</button>
        </form>
    </div>
</div>



<script>
function applyForm(type) {
    const input = document.getElementById('msgInput');
    const today = new Date().toISOString().split('T')[0];
    
    // Agentì˜ ticker ì •ë³´ë¥¼ í…œí”Œë¦¿ ë³€ìˆ˜ë¡œ ê°€ì ¸ì˜´
    const ticker = "{{ active_agent.ticker|default:'' }}";
    
    const forms = {
        // í•˜ë“œì½”ë”©ëœ ìˆ«ìì™€ ì¢…ëª©ëª…ì„ ì œê±°í•˜ê³  ë³€ìˆ˜ì™€ ë¹ˆì¹¸ìœ¼ë¡œ ëŒ€ì²´
        'buy': `[ë§¤ìˆ˜] ì¢…ëª©:${ticker}, ìˆ˜ëŸ‰: , ì´ì•¡: , ê±°ë˜ì¼:${today}`,
        'sell': `[ë§¤ë„] ì¢…ëª©:${ticker}, ìˆ˜ëŸ‰: , ì´ì•¡: , ê±°ë˜ì¼:${today}`,
        'perf': `[ì„±ê³¼] ì¢…ëª©:${ticker}, ê¸°ê°„:${today} ~ ${today}, ìˆ˜ìµë¥ : %`,
        'market': `[ì‹œì¥] ì¼ì:${today}, í•µì‹¬ë‚´ìš©: `
    };
    
    input.value = forms[type];
    
    // ì…ë ¥ì°½ìœ¼ë¡œ ì»¤ì„œ ì´ë™ ë° í¬ì»¤ìŠ¤
    input.focus();
    
    // ìˆ˜ëŸ‰ ì…ë ¥í•˜ê¸° í¸í•˜ê²Œ ì»¤ì„œ ìœ„ì¹˜ ì¡°ì • (ì„ íƒ ì‚¬í•­)
    if(type === 'buy' || type === 'sell') {
        const pos = input.value.indexOf('ìˆ˜ëŸ‰:') + 3;
        input.setSelectionRange(pos, pos);
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì±„íŒ…ì°½ í•˜ë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤
window.onload = function() {
    const chatBox = document.getElementById('chatBox');
    chatBox.scrollTop = chatBox.scrollHeight;
};
</script>
{% endblock %}